{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "VpcCidrBlock": {
      "Type": "String"
    },
    "VpcName": {
      "Type": "String"
    },
    "MasterApiPort": {
      "Type": "Number"
    },
    "MasterHealthTarget": {
      "Type": "String"
    },
    "Route53HostedZone": {
      "Type": "String"
    },
    "MasterClusterHostname": {
      "Type": "String"
    },
    "MasterClusterPublicHostname": {
      "Type": "String"
    },
    "AppWildcardDomain": {
      "Type": "String"
    },
    "NumSubnets": {
      "Type": "Number",
      "MinValue": "1",
      "MaxValue": "4",
      "Default": "1"
    },
    "SubnetAvailabilityZones": {
      "Type": "List<AWS::EC2::AvailabilityZone::Name>"
    },
    "SubnetCidrBlocks": {
      "Type": "CommaDelimitedList"
    },
    "KeyName": {
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "MasterInstanceType": {
      "Type": "String",
      "Default": "t2.medium"
    },
    "MasterImageId": {
      "Type": "AWS::EC2::Image::Id"
    },
    "MasterUserData": {
      "Type": "String"
    },
    "MasterRootVolSize": {
      "Type": "String",
      "Default": "30"
    },
    "MasterDockerVolSize": {
      "Type": "String",
      "Default": "25"
    },
    "MasterEtcdVolSize": {
      "Type": "String",
      "Default": "25"
    },
    "MasterEtcdVolType": {
      "Type": "String",
      "Default": "gp2"
    },
    "MasterDockerVolType": {
      "Type": "String",
      "Default": "gp2"
    },
    "MasterRootVolType": {
      "Type": "String",
      "Default": "gp2"
    },
    "InfraInstanceType": {
      "Type": "String",
      "Default": "t2.medium"
    },
    "InfraImageId": {
      "Type": "AWS::EC2::Image::Id"
    },
    "InfraUserData": {
      "Type": "String"
    },
    "InfraRootVolSize": {
      "Type": "String",
      "Default": "30"
    },
    "InfraDockerVolSize": {
      "Type": "String",
      "Default": "25"
    },
    "InfraDockerVolType": {
      "Type": "String",
      "Default": "gp2"
    },
    "InfraRootVolType": {
      "Type": "String",
      "Default": "gp2"
    },
    "NodeInstanceType": {
      "Type": "String",
      "Default": "t2.medium"
    },
    "NodeImageId": {
      "Type": "AWS::EC2::Image::Id"
    },
    "NodeUserData": {
      "Type": "String"
    },
    "NodeRootVolSize": {
      "Type": "String",
      "Default": "30"
    },
    "NodeDockerVolSize": {
      "Type": "String",
      "Default": "25"
    },
    "NodeDockerVolType": {
      "Type": "String",
      "Default": "gp2"
    },
    "NodeRootVolType": {
      "Type": "String",
      "Default": "gp2"
    },
    "NumMasters": {
      "Type": "Number",
      "AllowedValues": ["1", "3"],
      "Default": "1"
    },
    "NumInfra": {
      "Type": "Number",
      "MinValue": "1",
      "Default": "1"
    },
    "NumNodes": {
      "Type": "Number",
      "MinValue": "1",
      "Default": "1"
    },
    "RegistryVolumeSize": {
      "Type": "Number",
      "MinValue": "1",
      "MaxValue": "16384",
      "Default": "50"
    },
    "MetricsVolumeSize": {
      "Type": "Number",
      "MinValue": "1",
      "MaxValue": "16384",
      "Default": "100"
    },
    "LoggingVolumeSize": {
      "Type": "Number",
      "MinValue": "1",
      "MaxValue": "16384",
      "Default": "100"
    }
  },
  "Conditions": {
    "CreateSubnet2": {"Fn::Not": [{"Fn::Equals" : [{"Ref" : "NumSubnets"}, "1"]}]},
    "CreateSubnet3": {
      "Fn::Or": [
        {"Fn::Equals" : [{"Ref" : "NumSubnets"}, "3"]},
        {"Fn::Equals" : [{"Ref" : "NumSubnets"}, "4"]}
      ]
    },
    "CreateSubnet4": {"Fn::Equals" : [{"Ref" : "NumSubnets"}, "4"]}
  },
  "Outputs" : {
    "RegistryVolumeID" : {
      "Description" : "Registry Volume ID",
      "Value" : { "Ref": "RegistryVolume" }
    },
    "MetricsVolumeID" : {
      "Description" : "Metrics Volume ID",
      "Value" : { "Ref": "MetricsVolume" }
    },
    "LoggingVolumeID" : {
      "Description" : "Logging Volume ID",
      "Value" : { "Ref": "LoggingVolume" }
    }
  },
  "Resources": {
    "RegistryVolume": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AvailabilityZone" : {"Fn::Select": ["0", {"Ref": "SubnetAvailabilityZones"}]},
        "Size" : { "Ref": "RegistryVolumeSize" },
        "Tags": [ { "Key": "Name", "Value": {"Fn::Join": ["-", [{"Ref": "VpcName"}, "-pv-registry"]]} } ],
        "VolumeType" : "gp2"
      }
    },
    "MetricsVolume": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AvailabilityZone" : {"Fn::Select": ["0", {"Ref": "SubnetAvailabilityZones"}]},
        "Size" : { "Ref": "MetricsVolumeSize" },
        "Tags": [ { "Key": "Name", "Value": {"Fn::Join": ["-", [{"Ref": "VpcName"}, "-pv-metrics"]]} } ],
        "VolumeType" : "gp2"
      }
    },
    "LoggingVolume": {
      "Type": "AWS::EC2::Volume",
      "Properties": {
        "AvailabilityZone" : {"Fn::Select": ["0", {"Ref": "SubnetAvailabilityZones"}]},
        "Size" : { "Ref": "LoggingVolumeSize" },
        "Tags": [ { "Key": "Name", "Value": {"Fn::Join": ["-", [{"Ref": "VpcName"}, "-pv-logging"]]} } ],
        "VolumeType" : "gp2"
      }
    }
  }
}
